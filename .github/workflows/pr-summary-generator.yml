# .github/workflows/pr-summary-generator.yml
name: ğŸ¤– AI PR Summary Generator
on:
  pull_request:
    types: [opened]
    branches: [main]

jobs:
  generate-pr-summary:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    env:
      BACKEND_URL: https://pullquestgithubbackend.onrender.com
    
    steps:
      - name: ğŸ“‹ Debug PR Info
        run: |
          echo "ğŸ” PR #      : ${{ github.event.pull_request.number }}"
          echo "ğŸ” Title     : ${{ github.event.pull_request.title }}"
          echo "ğŸ” Author    : ${{ github.event.pull_request.user.login }}"
          echo "ğŸ” Repo      : ${{ github.event.repository.full_name }}"
          echo "ğŸ” Created   : ${{ github.event.pull_request.created_at }}"
          echo "ğŸ” Base      : ${{ github.event.pull_request.base.ref }}"
          echo "ğŸ” Head      : ${{ github.event.pull_request.head.ref }}"
      
      - name: ğŸ¤– Generate AI Summary
        id: ai-summary
        run: |
          NUMBER=${{ github.event.pull_request.number }}
          TITLE="${{ github.event.pull_request.title }}"
          DESCRIPTION="${{ github.event.pull_request.body || '' }}"
          AUTHOR="${{ github.event.pull_request.user.login }}"
          
          echo "ğŸ“ Generating AI-powered summary for PR #$NUMBER"
          echo "ğŸ‘¤ Author: $AUTHOR"
          echo "ğŸ“– Title: $TITLE"
          
          # Assemble comprehensive summary payload
          summary_payload=$(jq -n \
            --arg owner  "${{ github.event.repository.owner.login }}" \
            --arg repo   "${{ github.event.repository.name }}" \
            --arg title  "$TITLE" \
            --arg desc   "$DESCRIPTION" \
            --arg author "$AUTHOR" \
            --argjson prNumber "$NUMBER" \
            --arg createdAt "${{ github.event.pull_request.created_at }}" \
            --arg baseBranch "${{ github.event.pull_request.base.ref }}" \
            --arg headBranch "${{ github.event.pull_request.head.ref }}" \
            '{
              owner: $owner, 
              repo: $repo, 
              prNumber: $prNumber, 
              title: $title, 
              description: $desc, 
              author: $author,
              metadata: {
                createdAt: $createdAt,
                baseBranch: $baseBranch,
                headBranch: $headBranch
              }
            }')
          
          echo "ğŸ“¦ AI Summary Payload:"
          echo "$summary_payload" | jq '.'
          
          # Send request to backend with enhanced error handling
          echo "ğŸš€ Sending request to backend..."
          
          if summary_response=$(curl --fail --show-error --silent --max-time 60 \
            -X POST "$BACKEND_URL/api/github/generate-pr-summary" \
            -H "Content-Type: application/json" \
            -H "User-Agent: GitHub-Actions-PR-Summary/1.0" \
            --data-raw "$summary_payload" \
            -w '\nğŸ“Š HTTP Status: %{http_code}\nâ±ï¸  Response Time: %{time_total}s\n' 2>&1); then
            
            echo "âœ… AI Summary Generation Successful!"
            echo "ğŸ” Backend Response:"
            echo "$summary_response"
            echo "ai_summary_success=true" >> $GITHUB_OUTPUT
            
          else
            echo "âŒ AI Summary Generation Failed!"
            echo "ğŸ” Error Details:"
            echo "$summary_response"
            echo "ai_summary_success=false" >> $GITHUB_OUTPUT
            
            # Try to extract error details for debugging
            if echo "$summary_response" | grep -q "HTTP"; then
              HTTP_CODE=$(echo "$summary_response" | grep "HTTP" | grep -o '[0-9]*' | head -1)
              echo "ğŸ“Š HTTP Status Code: $HTTP_CODE"
              echo "http_status_code=$HTTP_CODE" >> $GITHUB_OUTPUT
            fi
          fi
      
      - name: ğŸ“ˆ Summary Analytics
        if: always()
        run: |
          echo "ğŸ“Š PR Summary Generation Analytics:"
          echo "ğŸ¯ Target PR: #${{ github.event.pull_request.number }}"
          echo "ğŸ‘¤ Author: ${{ github.event.pull_request.user.login }}"
          echo "ğŸ“ Title Length: $(echo '${{ github.event.pull_request.title }}' | wc -c) characters"
          echo "ğŸ“„ Description Length: $(echo '${{ github.event.pull_request.body }}' | wc -c) characters"
          echo "ğŸ¤– AI Generation Status: ${{ steps.ai-summary.outputs.ai_summary_success }}"
          
          if [ "${{ steps.ai-summary.outputs.ai_summary_success }}" = "true" ]; then
            echo "âœ… Summary successfully posted to PR #${{ github.event.pull_request.number }}"
            echo "ğŸ”— View PR: ${{ github.event.pull_request.html_url }}"
          else
            echo "âŒ Summary generation failed for PR #${{ github.event.pull_request.number }}"
            if [ -n "${{ steps.ai-summary.outputs.http_status_code }}" ]; then
              echo "ğŸ“Š HTTP Status: ${{ steps.ai-summary.outputs.http_status_code }}"
            fi
          fi
      
      - name: ğŸ¯ Completion Report
        run: |
          echo "ğŸ‰ PR Summary Workflow Completed!"
          echo "=================================="
          echo "ğŸ“‹ Summary:"
          echo "  â€¢ PR Number: #${{ github.event.pull_request.number }}"
          echo "  â€¢ Repository: ${{ github.event.repository.full_name }}"
          echo "  â€¢ Author: ${{ github.event.pull_request.user.login }}"
          echo "  â€¢ AI Summary: ${{ steps.ai-summary.outputs.ai_summary_success }}"
          echo "=================================="
          
          if [ "${{ steps.ai-summary.outputs.ai_summary_success }}" = "true" ]; then
            echo "ğŸš€ Next Steps:"
            echo "  â€¢ Review the AI-generated summary in the PR comments"
            echo "  â€¢ Validate the analysis accuracy"
            echo "  â€¢ Use insights for code review process"
          else
            echo "ğŸ”§ Troubleshooting:"
            echo "  â€¢ Check backend logs for detailed error information"
            echo "  â€¢ Verify API key and endpoint availability"
            echo "  â€¢ Consider manual summary generation if needed"
          fi
          
          echo "ğŸ”— PR Link: ${{ github.event.pull_request.html_url }}"