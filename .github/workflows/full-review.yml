name: PullQuestAI Full Review

on:
  issue_comment:
    types: [created]

jobs:
  handle-full-review:
    # Only run on pull request comments
    if: github.event.issue.pull_request
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: read
    env:
      BACKEND_URL: https://pullquestgithubbackend.onrender.com

    steps:
    - name: Check if comment requests a full review
      id: check-comment
      run: |
        comment_body="${{ github.event.comment.body }}"
        if [[ "$comment_body" == *"@pullquestai full review"* ]]; then
          echo "trigger_action=true" >> $GITHUB_OUTPUT
          echo "✅ Full review request detected!"
        else
          echo "trigger_action=false" >> $GITHUB_OUTPUT
          echo "ℹ️ Not a full review request, skipping..."
        fi

    - name: Debug – print extracted info
      if: steps.check-comment.outputs.trigger_action == 'true'
      run: |
        echo "🔍 PR #       : ${{ github.event.issue.number }}"
        echo "🔍 Requester  : ${{ github.event.comment.user.login }}"
        echo "🔍 Repo       : ${{ github.event.repository.full_name }}"

    - name: Build payload ➜ POST to backend
      if: steps.check-comment.outputs.trigger_action == 'true'
      run: |
        PR_NUMBER=${{ github.event.issue.number }}
        REQUESTER="${{ github.event.comment.user.login }}"
        
        # Assemble payload for a full review request
        payload=$(jq -n \
          --arg owner      "${{ github.event.repository.owner.login }}" \
          --arg repo       "${{ github.event.repository.name }}" \
          --arg requester  "$REQUESTER" \
          --argjson prNumber "$PR_NUMBER" \
          '{
            owner: $owner,
            repo: $repo, 
            prNumber: $prNumber,
            requester: $requester
          }')
        
        echo "📦 Payload:"
        echo "$payload"
        
        response=$(curl --fail --show-error --silent \
          -X POST "$BACKEND_URL/api/chatgpt/full-review" \
          -H "Content-Type: application/json" \
          --data-raw "$payload" \
          -w '\nHTTP %{http_code}\n' )
        
        echo "🔍 Response: $response"

    - name: Done
      if: steps.check-comment.outputs.trigger_action == 'true'
      run: echo "✅ PullQuestAI backend notified for a full review"
