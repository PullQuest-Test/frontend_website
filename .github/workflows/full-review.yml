# .github/workflows/ai-pr-review.yml
name: AI PR Review with Hedera Rewards

on:
  pull_request:
    types: [opened, reopened, synchronize] # Run for new PRs and new commits to existing PRs
    branches: [main]

jobs:
  ai_review:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write # Required for the backend to post comments

    env:
      BACKEND_URL: https://pullquestgithubbackend-1.onrender.com # Your backend URL

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Build the JSON payload and send it to your backend.
      - name: Trigger AI PR Review
        run: |
          # The payload needs owner, repo, prNumber, author, and the GITHUB_TOKEN.
          payload=$(jq -n \
            --arg owner    "${{ github.repository_owner }}" \
            --arg repo     "${{ github.event.repository.name }}" \
            --argjson prNumber "${{ github.event.pull_request.number }}" \
            --arg author   "${{ github.event.pull_request.user.login }}" \
            --arg githubToken "${{ secrets.GITHUB_TOKEN }}" \
            '{ owner: $owner,
               repo: $repo,
               prNumber: $prNumber,
               author: $author,
               githubToken: $githubToken }')

          echo "ðŸ“¦ Payload being sent to /api/hedera/ai-pr-review:"
          echo "$payload" | jq 'del(.githubToken) | . + {githubToken: "REDACTED"}' # Avoid logging the token

          # Call the correct endpoint with the required payload.
          curl --fail --show-error --silent \
               -X POST "$BACKEND_URL/api/hedera/ai-pr-review" \
               -H "Content-Type: application/json" \
               --data-binary "$payload"

      - name: Done
        if: success()
        run: echo "ðŸŽ‰ Workflow complete â€” AI review has been triggered."
